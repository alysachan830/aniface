<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aniface - Ready Player Me Example</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: white;
    }

    .container {
      max-width: 1200px;
      width: 100%;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 2rem;
      opacity: 0.9;
    }

    .demo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
      .demo-grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .panel h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #webcam {
      width: 100%;
      border-radius: 8px;
      background: #000;
      display: block;
    }

    #avatar {
      width: 100%;
      height: 500px;
      border-radius: 8px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      display: block;
      cursor: grab;
    }

    #avatar:active {
      cursor: grabbing;
    }

    .controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    button {
      flex: 1;
      padding: 12px 24px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: #10b981;
      color: white;
    }

    .btn-secondary {
      background: #f59e0b;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-loading {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.4);
    }

    .status-success {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.4);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .status-warning {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .info {
      font-size: 0.9rem;
      opacity: 0.8;
      line-height: 1.6;
    }

    .info-box {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.4);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .footer {
      text-align: center;
      margin-top: 2rem;
      opacity: 0.7;
      font-size: 0.9rem;
    }

    .footer a {
      color: white;
      text-decoration: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      transition: border-color 0.3s ease;
    }

    .footer a:hover {
      border-bottom-color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé≠ Aniface + Ready Player Me</h1>
    <p class="subtitle">Animate your Ready Player Me avatar with real-time facial tracking</p>

    <div class="demo-grid">
      <!-- Webcam Panel -->
      <div class="panel">
        <h2>üìπ Webcam</h2>
        <video id="webcam" autoplay playsinline></video>
      </div>

      <!-- Avatar Panel -->
      <div class="panel">
        <h2>üßë Ready Player Me Avatar</h2>
        <canvas id="avatar"></canvas>
      </div>
    </div>

    <!-- Controls Panel -->
    <div class="controls">
      <div class="info-box">
        <strong>‚ÑπÔ∏è About this demo:</strong> This example uses a Ready Player Me avatar with ARKit blendshapes. 
        The avatar is loaded directly from the RPM API with <code>?morphTargets=ARKit</code> to enable facial animation.
      </div>

      <div id="status" class="status status-loading">
        <div class="spinner"></div>
        <span>Initializing...</span>
      </div>

      <div class="button-group">
        <button id="startBtn" class="btn-primary" disabled>Start Tracking</button>
        <button id="stopBtn" class="btn-secondary" disabled>Stop</button>
      </div>

      <div class="info">
        <strong>Instructions:</strong>
        <ul style="margin-left: 20px; margin-top: 5px;">
          <li>Click "Start Tracking" to begin</li>
          <li>Look at the camera and see your RPM avatar mimic your expressions!</li>
          <li>Try smiling, blinking, opening your mouth, raising eyebrows</li>
          <li>Drag with mouse to rotate, scroll to zoom the avatar view</li>
        </ul>
      </div>
    </div>

    <div class="footer">
      Built with <a href="https://github.com/google/mediapipe">MediaPipe</a>, 
      <a href="https://threejs.org/">Three.js</a>, and 
      <a href="https://readyplayer.me/">Ready Player Me</a>
    </div>
  </div>

  <script type="module">
    import { FacialAvatar } from '../../src/index.ts'

    let avatar = null
    let webcamStream = null

    const webcam = document.getElementById('webcam')
    const canvas = document.getElementById('avatar')
    const startBtn = document.getElementById('startBtn')
    const stopBtn = document.getElementById('stopBtn')
    const statusEl = document.getElementById('status')

    // Ready Player Me model URL with ARKit blendshapes
    const RPM_MODEL_URL = 'https://models.readyplayer.me/691315d7a577a4cbdaf75330.glb?morphTargets=ARKit&useHands=false'

    // Status helper
    function setStatus(message, type = 'loading') {
      statusEl.className = `status status-${type}`
      
      if (type === 'loading') {
        statusEl.innerHTML = `<div class="spinner"></div><span>${message}</span>`
      } else {
        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è'
        }
        statusEl.innerHTML = `<span>${icons[type] || ''} ${message}</span>`
      }
    }

    // Initialize webcam
    async function initWebcam() {
      try {
        setStatus('Requesting camera access...', 'loading')
        
        webcamStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          },
          audio: false
        })
        
        webcam.srcObject = webcamStream
        
        // Wait for video to be ready
        await new Promise((resolve) => {
          webcam.onloadedmetadata = resolve
        })
        
        console.log('‚úÖ Webcam initialized')
        return true
      } catch (error) {
        console.error('Failed to access webcam:', error)
        setStatus('Camera access denied. Please allow camera access.', 'error')
        return false
      }
    }

    // Initialize avatar system with Ready Player Me model
    async function initAvatar() {
      try {
        setStatus('Loading Ready Player Me avatar...', 'loading')
        
        avatar = new FacialAvatar({
          videoElement: webcam,
          canvasElement: canvas,
          modelPath: RPM_MODEL_URL,
          
          // Camera configuration
          cameraConfig: {
            fov: 50,                         // Wider FOV for full body visibility
            enableControls: true,            // Enable rotation for RPM full-body avatar
            enableZoom: true                 // Users can zoom to focus on the face
          },
          
          // Blendshape adjustments
          // Start with conservative values, can be adjusted based on testing
          blendshapeMultipliers: {
            eyeBlinkLeft: 1.3,
            eyeBlinkRight: 1.3,
            browInnerUp: 1.2,
            browOuterUpLeft: 1.2,
            browOuterUpRight: 1.2,
            jawOpen: 1.0,
            mouthSmileLeft: 1.0,
            mouthSmileRight: 1.0,
          },
          
          // Improved lighting for better visibility and depth
          lightingConfig: {
            ambientIntensity: 1.2,           // Increased ambient light for overall brightness
            directionalIntensity: 1.5,       // Stronger main light
            directionalPosition: [2, 3, 3]   // Light from top-right front
          },
          
          // Model positioning
          modelOptions: {
            center: true,                    // Center model at origin
            autoRotate: false,               // No rotation - model naturally faces camera
            rotation: 0,                     // No rotation needed
            scale: 2.4,                      // Scale for better visibility
            applyTransformToHeadOnly: true   // Only move head, keep body fixed
          },
          
          onReady: () => {
            console.log('‚úÖ Ready Player Me avatar ready')
            setStatus('Ready! Click "Start Tracking" to begin', 'success')
            startBtn.disabled = false
          },
          
          onError: (error) => {
            console.error('Avatar error:', error)
            setStatus(`Error: ${error.message}`, 'error')
          },
          
          onLandmarksDetected: (results) => {
            // Optional: track detection stats
            if (results.faceBlendshapes && results.faceBlendshapes.length > 0) {
              // Successfully detecting face and blendshapes
            }
          },
          
          onNoFaceDetected: () => {
            // Face temporarily lost
          }
        })
        
        await avatar.initialize()
        
      } catch (error) {
        console.error('Failed to initialize avatar:', error)
        setStatus(`Initialization failed: ${error.message}`, 'error')
      }
    }

    // Start tracking
    function startTracking() {
      if (!avatar) return
      
      avatar.start()
      setStatus('Tracking active - Move your face!', 'success')
      
      startBtn.disabled = true
      stopBtn.disabled = false
    }

    // Stop tracking
    function stopTracking() {
      if (!avatar) return
      
      avatar.stop()
      setStatus('Tracking paused', 'warning')
      
      startBtn.disabled = false
      stopBtn.disabled = true
    }

    // Event listeners
    startBtn.addEventListener('click', startTracking)
    stopBtn.addEventListener('click', stopTracking)

    // Handle window resize
    window.addEventListener('resize', () => {
      if (avatar) {
        const rect = canvas.getBoundingClientRect()
        canvas.width = rect.width
        canvas.height = rect.height
        avatar.updateSize(canvas.width, canvas.height)
      }
    })

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (avatar) {
        avatar.destroy()
      }
      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop())
      }
    })

    // Initialize everything
    async function init() {
      const webcamOk = await initWebcam()
      if (webcamOk) {
        await initAvatar()
      }
    }

    // Start initialization
    init()
  </script>
</body>
</html>

